<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Test - Movement System</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff41;
            overflow-x: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            border: 2px solid #00ff41;
            background: rgba(0, 255, 65, 0.05);
        }
        
        .test-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .test-box {
            flex: 1;
            border: 1px solid #00ff41;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
        }
        
        canvas {
            border: 1px solid #00ff41;
            background: #000;
            display: block;
            margin: 10px auto;
        }
        
        .performance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .stat {
            background: rgba(0, 255, 65, 0.1);
            padding: 10px;
            border: 1px solid #00ff41;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff41;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
        }
        
        .controls {
            background: rgba(0, 255, 65, 0.1);
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #00ff41;
        }
        
        button {
            background: transparent;
            color: #00ff41;
            border: 1px solid #00ff41;
            padding: 8px 16px;
            margin: 0 5px;
            cursor: pointer;
            font-family: inherit;
        }
        
        button:hover {
            background: rgba(0, 255, 65, 0.2);
        }
        
        .log {
            background: #000;
            border: 1px solid #00ff41;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .warning {
            color: #ff4444;
            font-weight: bold;
        }
        
        .success {
            color: #44ff44;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚀 MOVEMENT SYSTEM PERFORMANCE TEST</h1>
        <p>Ultra-lightweight movement system - no collision detection</p>
        <p>This should run at 60+ FPS without freezing your browser!</p>
    </div>

    <div class="performance-stats">
        <div class="stat">
            <div class="stat-value" id="fps">0</div>
            <div class="stat-label">FPS</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="frameTime">0</div>
            <div class="stat-label">Frame Time (ms)</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="playerSpeed">0</div>
            <div class="stat-label">Player Speed</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="position">0, 0</div>
            <div class="stat-label">Position</div>
        </div>
    </div>

    <div class="controls">
        <strong>Controls:</strong> 
        WASD or Arrow Keys to move | 
        <button onclick="test.toggleBounds()">Toggle Bounds</button>
        <button onclick="test.resetPosition()">Reset Position</button>
        <button onclick="test.stressTest()">Stress Test (100 objects)</button>
    </div>

    <canvas id="gameCanvas" width="1000" height="600"></canvas>

    <div class="log" id="logOutput">
        <div class="success">✅ Performance test initialized</div>
        <div>🎮 Use WASD or arrow keys to move</div>
        <div>📊 Monitoring performance metrics...</div>
    </div>

    <script>
        class PerformanceMovementTest {
            constructor(canvas) {
                this.canvas = canvas
                this.ctx = canvas.getContext('2d')
                
                // Player state
                this.player = {
                    x: 500,
                    y: 300,
                    vx: 0,
                    vy: 0,
                    radius: 16,
                    color: '#00ff41'
                }
                
                // Input state
                this.keys = new Set()
                this.mouse = { x: 0, y: 0 }
                
                // Movement settings
                this.speed = 400 // pixels per second
                this.deadzone = 0.1
                this.boundsEnabled = true
                
                // Performance tracking
                this.lastTime = 0
                this.frameCount = 0
                this.fps = 0
                this.frameTime = 0
                this.lastFpsUpdate = 0
                this.frameTimes = []
                
                // Stress test objects
                this.stressObjects = []
                this.stressTestActive = false
                
                this.setupEvents()
                this.start()
                this.log('🚀 Ultra-lightweight movement system started', 'success')
            }
            
            setupEvents() {
                // Keyboard
                document.addEventListener('keydown', (e) => {
                    this.keys.add(e.code)
                    e.preventDefault()
                })
                
                document.addEventListener('keyup', (e) => {
                    this.keys.delete(e.code)
                    e.preventDefault()
                })
                
                // Mouse
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect()
                    this.mouse.x = e.clientX - rect.left
                    this.mouse.y = e.clientY - rect.top
                })
            }
            
            getInput() {
                let x = 0, y = 0
                
                if (this.keys.has('KeyW') || this.keys.has('ArrowUp')) y -= 1
                if (this.keys.has('KeyS') || this.keys.has('ArrowDown')) y += 1
                if (this.keys.has('KeyA') || this.keys.has('ArrowLeft')) x -= 1
                if (this.keys.has('KeyD') || this.keys.has('ArrowRight')) x += 1
                
                return { x, y }
            }
            
            update(deltaTime) {
                const dt = deltaTime / 1000
                const input = this.getInput()
                
                // Ultra-fast movement update (same as our optimized MovementSystem)
                const inputMag = input.x * input.x + input.y * input.y
                if (inputMag < this.deadzone * this.deadzone) {
                    this.player.vx = this.player.vy = 0
                } else {
                    const magnitude = Math.sqrt(inputMag)
                    const normalizedX = input.x / magnitude
                    const normalizedY = input.y / magnitude
                    
                    this.player.vx = normalizedX * this.speed
                    this.player.vy = normalizedY * this.speed
                }
                
                // Update position directly (no collision checks)
                this.player.x += this.player.vx * dt
                this.player.y += this.player.vy * dt
                
                // Optional bounds checking
                if (this.boundsEnabled) {
                    const margin = this.player.radius
                    if (this.player.x < margin) this.player.x = margin
                    if (this.player.x > this.canvas.width - margin) this.player.x = this.canvas.width - margin
                    if (this.player.y < margin) this.player.y = margin
                    if (this.player.y > this.canvas.height - margin) this.player.y = this.canvas.height - margin
                }
                
                // Update stress test objects
                if (this.stressTestActive) {
                    for (let obj of this.stressObjects) {
                        obj.x += obj.vx * dt
                        obj.y += obj.vy * dt
                        
                        if (obj.x < 0 || obj.x > this.canvas.width) obj.vx *= -1
                        if (obj.y < 0 || obj.y > this.canvas.height) obj.vy *= -1
                    }
                }
                
                this.updatePerformanceStats(deltaTime)
            }
            
            render() {
                // Clear with fade effect for trails
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height)
                
                // Draw grid
                this.ctx.strokeStyle = '#001100'
                this.ctx.lineWidth = 1
                for (let x = 0; x < this.canvas.width; x += 100) {
                    this.ctx.beginPath()
                    this.ctx.moveTo(x, 0)
                    this.ctx.lineTo(x, this.canvas.height)
                    this.ctx.stroke()
                }
                for (let y = 0; y < this.canvas.height; y += 100) {
                    this.ctx.beginPath()
                    this.ctx.moveTo(0, y)
                    this.ctx.lineTo(this.canvas.width, y)
                    this.ctx.stroke()
                }
                
                // Draw stress test objects
                if (this.stressTestActive) {
                    for (let obj of this.stressObjects) {
                        this.ctx.fillStyle = obj.color
                        this.ctx.beginPath()
                        this.ctx.arc(obj.x, obj.y, obj.radius, 0, Math.PI * 2)
                        this.ctx.fill()
                    }
                }
                
                // Draw player
                this.ctx.fillStyle = this.player.color
                this.ctx.beginPath()
                this.ctx.arc(this.player.x, this.player.y, this.player.radius, 0, Math.PI * 2)
                this.ctx.fill()
                
                // Draw velocity vector
                if (this.player.vx !== 0 || this.player.vy !== 0) {
                    this.ctx.strokeStyle = '#ffff00'
                    this.ctx.lineWidth = 2
                    this.ctx.beginPath()
                    this.ctx.moveTo(this.player.x, this.player.y)
                    this.ctx.lineTo(
                        this.player.x + this.player.vx * 0.1,
                        this.player.y + this.player.vy * 0.1
                    )
                    this.ctx.stroke()
                }
                
                // Draw crosshair at mouse
                this.ctx.strokeStyle = '#00ffff'
                this.ctx.lineWidth = 1
                this.ctx.beginPath()
                this.ctx.moveTo(this.mouse.x - 15, this.mouse.y)
                this.ctx.lineTo(this.mouse.x + 15, this.mouse.y)
                this.ctx.moveTo(this.mouse.x, this.mouse.y - 15)
                this.ctx.lineTo(this.mouse.x, this.mouse.y + 15)
                this.ctx.stroke()
            }
            
            updatePerformanceStats(deltaTime) {
                // Track frame times
                this.frameTimes.push(deltaTime)
                if (this.frameTimes.length > 60) {
                    this.frameTimes.shift()
                }
                
                // Calculate average frame time
                this.frameTime = this.frameTimes.reduce((a, b) => a + b, 0) / this.frameTimes.length
                
                // Update FPS counter
                this.frameCount++
                const now = performance.now()
                if (now - this.lastFpsUpdate > 1000) {
                    this.fps = this.frameCount
                    this.frameCount = 0
                    this.lastFpsUpdate = now
                    
                    // Update UI
                    document.getElementById('fps').textContent = this.fps
                    document.getElementById('frameTime').textContent = this.frameTime.toFixed(1)
                    document.getElementById('playerSpeed').textContent = Math.sqrt(this.player.vx * this.player.vx + this.player.vy * this.player.vy).toFixed(0)
                    document.getElementById('position').textContent = `${this.player.x.toFixed(0)}, ${this.player.y.toFixed(0)}`
                    
                    // Performance warnings
                    if (this.fps < 30) {
                        this.log(`⚠️ Low FPS detected: ${this.fps}`, 'warning')
                    } else if (this.fps >= 60) {
                        // Only log once when achieving good performance
                        if (!this.goodPerformanceLogged) {
                            this.log(`✅ Excellent performance: ${this.fps} FPS`, 'success')
                            this.goodPerformanceLogged = true
                        }
                    }
                }
            }
            
            gameLoop(currentTime) {
                if (this.lastTime === 0) {
                    this.lastTime = currentTime
                }
                
                const deltaTime = Math.min(currentTime - this.lastTime, 50)
                this.lastTime = currentTime
                
                if (deltaTime > 0) {
                    this.update(deltaTime)
                    this.render()
                }
                
                requestAnimationFrame((time) => this.gameLoop(time))
            }
            
            // Test controls
            toggleBounds() {
                this.boundsEnabled = !this.boundsEnabled
                this.log(`Bounds ${this.boundsEnabled ? 'enabled' : 'disabled'}`)
            }
            
            resetPosition() {
                this.player.x = 500
                this.player.y = 300
                this.player.vx = 0
                this.player.vy = 0
                this.log('Position reset to center')
            }
            
            stressTest() {
                if (this.stressTestActive) {
                    this.stressObjects = []
                    this.stressTestActive = false
                    this.log('Stress test stopped', 'success')
                } else {
                    this.log('Starting stress test with 100 moving objects...', 'warning')
                    this.stressObjects = []
                    
                    for (let i = 0; i < 100; i++) {
                        this.stressObjects.push({
                            x: Math.random() * this.canvas.width,
                            y: Math.random() * this.canvas.height,
                            vx: (Math.random() - 0.5) * 400,
                            vy: (Math.random() - 0.5) * 400,
                            radius: 3 + Math.random() * 5,
                            color: `hsl(${Math.random() * 360}, 70%, 50%)`
                        })
                    }
                    
                    this.stressTestActive = true
                    this.log('Stress test active - monitor FPS', 'warning')
                }
            }
            
            log(message, type = 'normal') {
                const logOutput = document.getElementById('logOutput')
                const div = document.createElement('div')
                div.className = type
                div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
                logOutput.appendChild(div)
                logOutput.scrollTop = logOutput.scrollHeight
                
                // Keep only last 20 log entries
                while (logOutput.children.length > 20) {
                    logOutput.removeChild(logOutput.firstChild)
                }
            }
            
            start() {
                this.log('🎮 Starting performance test...', 'success')
                this.gameLoop(0)
            }
        }
        
        // Start the test
        const canvas = document.getElementById('gameCanvas')
        const test = new PerformanceMovementTest(canvas)
        
        // Make test available globally for button controls
        window.test = test
        
        // Log system info
        setTimeout(() => {
            test.log(`Browser: ${navigator.userAgent.split(' ').slice(-2).join(' ')}`)
            test.log(`Screen: ${screen.width}x${screen.height}`)
            test.log('🚀 Performance test ready - try moving around!', 'success')
        }, 1000)
    </script>
</body>
</html>